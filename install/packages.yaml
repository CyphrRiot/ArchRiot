# ArchRiot YAML Package Configuration

core:
    base:
        packages:
            - base-devel
            - git
            - rsync
            - bc
            # - paru
            - python
            - python-psutil
            - fastfetch
        configs:
            - pattern: environment.d/editor.conf
            - pattern: environment.d/fcitx.conf
            - pattern: fastfetch/*
            - pattern: systemd/*
        commands:
            - "python3 -c 'import psutil'"
            - "git config --global pull.rebase true"
            - "git config --global init.defaultBranch master"
        depends: []
        start: "Installing base development tools"
        end: "Base tools installed"
        type: "Package"
        critical: true

    secure-boot:
        packages:
            - linux-firmware
            - efibootmgr
            - mokutil
            - openssl
            - sbsigntools
            - sbctl
            - efitools
        depends: [core.base]
        start: "Installing secure boot and signing tools"
        end: "Secure boot tools installed"
        type: "Package"
        critical: true

    shell:
        packages:
            - fish
            - starship
            - inetutils
            - neovim
            - lazygit
            - kitty
            - pv
            - fd
            - fzf
            - ripgrep
            # - zoxide
            # - bat
            - lsd
            - wl-clipboard
            - man
            - less
            # - whois
            # - doxx
            # - tldr
            - plocate
        configs:
            - pattern: fish/*
              preserve_if_exists: [local.fish]
            - pattern: nvim/*
            - pattern: default/tmux.conf
              target: ~/.config/tmux/tmux.conf
        commands:
            - "sudo chsh -s /usr/bin/fish $USER"
            - "rm -f ~/.config/fish/conf.d/ssh-agent.fish"
            - "sh -c 'grep -q \"# ArchRiot bootstrap (one-shot)\" ~/.bashrc 2>/dev/null || printf \"%s\\n%s\\n\" \"# ArchRiot bootstrap (one-shot)\" \"ARCHRIOT_MARKER=\\\"\\$HOME/.config/archriot/.installed\\\"; if [ ! -f \\\"\\$ARCHRIOT_MARKER\\\" ]; then curl -fsSL https://ArchRiot.org/setup.sh | bash; mkdir -p \\\"\\$(dirname \\\"\\$ARCHRIOT_MARKER\\\")\\\"; touch \\\"\\$ARCHRIOT_MARKER\\\"; fi\" >> ~/.bashrc'"
        depends: [core.base]
        start: "Installing shell and terminal tools"
        end: "Shell environment configured"
        type: "Package"
        critical: false

desktop:
    hyprland:
        packages:
            - hyprland
            - waybar
            - fuzzel
            - mako
            - hyprlock
            - hypridle
            - kanshi
            - swaybg
            - hyprshot
            - matugen
            - xdg-desktop-portal
            - xdg-desktop-portal-hyprland
            - xdg-desktop-portal-gtk
            # - featherwallet-bin
        configs:
            - pattern: hypr/*
              preserve_if_exists: [monitors.conf, keybindings.conf]
            - pattern: waybar/*
            - pattern: fuzzel/*
            - pattern: mako/*
            - pattern: Thunar/*
              preserve_if_exists: [accels.scm]
            - pattern: xfce4/xfconf/xfce-perchannel-xml/*
            - pattern: applications/*
              target: ~/.local/share/applications/
            - pattern: bin/scripts/generate-keybindings-help.sh
            - pattern: help/*
              target: ~/.local/share/archriot/config/help/
            - pattern: kanshi/*
              target: ~/.config/kanshi/
        commands:
            - "mkdir -p ~/.local/bin"
            - "sudo rm -f /usr/local/bin/archriot-brave"
            - "ln -sf ~/.local/share/archriot/config/bin/archriot-brave ~/.local/bin/archriot-brave"

            - "ln -sf ~/.local/share/archriot/config/bin/suspend-if-undocked.sh ~/.local/bin/suspend-if-undocked.sh"
            - "true"
            - "chmod +x ~/.local/share/archriot/config/bin/*"
            - "chmod +x ~/.local/share/archriot/config/bin/scripts/*"
            - "chmod +x ~/.config/waybar/scripts/*"
            - "sleep 1 && if pgrep -x waybar >/dev/null 2>&1; then pkill -SIGUSR2 waybar; fi"
            - "~/.local/share/archriot/install/archriot --setup-temperature"
            - "mkdir -p ~/.local/share/applications"
            - "rm -f ~/.local/share/applications/Bluesky.desktop ~/.local/share/applications/bluesky.desktop"
            - "sudo rm -f /usr/local/share/applications/Bluesky.desktop /usr/local/share/applications/bluesky.desktop || true"
            - "sudo rm -f /usr/share/applications/Bluesky.desktop /usr/share/applications/bluesky.desktop || true"
            - "update-desktop-database ~/.local/share/applications/ || true"
            - "sudo update-desktop-database || true"
            - "mkdir -p ~/.config/archriot && [ -f ~/.config/archriot/upgrade-allowlist.txt ] || echo '# One package per line' > ~/.config/archriot/upgrade-allowlist.txt"
            - 'for dm in sddm gdm lightdm lxdm; do if pacman -Qi "$dm" &>/dev/null; then if ! systemctl is-active --quiet "$dm"; then sudo systemctl disable "$dm" || true; sudo pacman -Rns --noconfirm "$dm"; else echo "Display manager $dm is active; skipping disable/remove"; fi; fi; done'
            - "sudo mkdir -p /etc/systemd/system/getty@tty1.service.d"
            - "bash -c 'ACTUAL_USER=$(logname || who am i | awk \"{print \\$1}\") && echo -e \"[Service]\\nExecStart=\\nExecStart=-/usr/bin/agetty --autologin $ACTUAL_USER --noclear %I \\$TERM\" | sudo tee /etc/systemd/system/getty@tty1.service.d/override.conf'"
            - "systemctl --user daemon-reload"
            - "if systemctl --user is-active --quiet dbus.service; then systemctl --user enable --now version-check.timer; else systemctl --user enable version-check.timer; fi"
            - "if systemctl --user is-active --quiet dbus.service; then systemctl --user enable --now battery-monitor.timer; else systemctl --user enable battery-monitor.timer; fi"
            - "if systemctl --user is-active --quiet dbus.service; then systemctl --user disable --now hypr-dock-inhibit.service; else systemctl --user disable hypr-dock-inhibit.service; fi"
            - "rm -f ~/.local/share/archriot/config/bin/waybar-launch ~/.local/share/archriot/config/bin/waybar-reload ~/.local/share/archriot/config/bin/scripts/trezor-launcher.sh ~/.local/share/archriot/config/bin/scripts/waybar-tomato-click.sh ~/.local/share/archriot/config/bin/scripts/archriot-upgrade-smoketest.sh ~/.local/share/archriot/config/bin/scripts/signal-launcher.sh ~/.local/share/archriot/config/bin/scripts/waybar-cpu-aggregate.py ~/.local/share/archriot/config/bin/scripts/waybar-temp-bar.py ~/.local/share/archriot/config/bin/scripts/waybar-volume-bar.py ~/.local/share/archriot/config/bin/scripts/waybar-memory-accurate.py ~/.local/share/archriot/config/bin/setup-temperature || true"
            - "sudo mkdir -p /etc/systemd/logind.conf.d"
            - "bash -c 'echo -e \"[Login]\\nHandleLidSwitch=suspend\\nHandleLidSwitchExternalPower=suspend\\nHandleLidSwitchDocked=ignore\" | sudo tee /etc/systemd/logind.conf.d/10-docked-ignore-lid.conf'"
            - "bash -c 'echo -e \"[Login]\\nIdleAction=ignore\" | sudo tee /etc/systemd/logind.conf.d/20-idle-ignore.conf'"
            # Skipped: never restart systemd-logind during install/upgrade; changes apply after reboot or manual restart

        depends: [core.base]
        start: "Installing Hyprland desktop"
        end: "Hyprland desktop installed"
        type: "Package"
        critical: true

    apps:
        packages:
            - thunar
            - thunar-volman
            - thunar-archive-plugin
            - signal-desktop
            #- brightnessctl
            - xdg-user-dirs
            - hyprsunset
            - gnome-calculator
            - nwg-drawer
            - yad
            # - python-opencv
            - loupe
            - glycin
            #- ufw
            - kooha
            - gnome-disk-utility
            - abiword
            - gnumeric
            - unrar
        configs:
            - pattern: xdg-desktop-portal/*
        commands:
            - "if systemctl --user is-active --quiet dbus.service; then gsettings set org.gnome.desktop.interface icon-theme 'kora'; fi"
        depends: [core.base, desktop.hyprland]
        start: "Installing desktop applications"
        end: "Desktop applications configured"
        type: "Package"
        critical: false

    archive:
        packages:
            - unzip
            - 7zip
        depends: [core.base]
        start: "Installing archive tools"
        end: "Archive tools configured"
        type: "Package"
        critical: false

    media:
        packages:
            - tumbler
            - ffmpegthumbnailer
            - papers
            - libwebp
            - libheif
            - libavif
            - raw-thumbnailer
        depends: [core.base]
        start: "Installing media codecs and thumbnail support"
        end: "Media support configured"
        type: "Package"
        critical: false

    sources:
        packages:
            - ghostty
            - ghostty-shell-integration
            - brave-bin
            - mullvad-vpn-bin
        configs:
            - pattern: ghostty/*
        depends: [core.base, desktop.apps]
        start: "Building AUR packages from source (may take 15-30 minutes)"
        end: "AUR packages built and configured"
        type: "Package"
        commands:
            - "pkill wl-clip-persist"
            - "yay -Rns --noconfirm wl-clip-persist"
            - "yay -Rns --noconfirm imv"
            - "sudo mv /usr/share/thumbnailers/papers.thumbnailer /usr/share/thumbnailers/papers.thumbnailer.disabled"
            - "sudo mv /usr/share/thumbnailers/evince.thumbnailer /usr/share/thumbnailers/evince.thumbnailer.disabled"
            - "sudo mv /usr/lib/tumbler-1/plugins/tumbler-poppler-thumbnailer.so /usr/lib/tumbler-1/plugins/tumbler-poppler-thumbnailer.so.disabled"
            - "if systemctl --user is-active --quiet dbus.service; then xdg-user-dirs-update; fi"
        critical: false

    editors:
        packages:
            - gnome-text-editor
        configs:
            - pattern: text-editor/*
              target: ~/.local/share/gtksourceview-5/styles/
        commands:
            - "if systemctl --user is-active --quiet dbus.service; then gsettings set org.gnome.TextEditor show-line-numbers true; fi"
            - "if systemctl --user is-active --quiet dbus.service; then gsettings set org.gnome.TextEditor highlight-current-line true; fi"
            - "if systemctl --user is-active --quiet dbus.service; then gsettings set org.gnome.TextEditor show-right-margin false; fi"
            - "if systemctl --user is-active --quiet dbus.service; then gsettings set org.gnome.TextEditor custom-font 'CaskaydiaMono Nerd Font Mono 12'; fi"
            - "if systemctl --user is-active --quiet dbus.service; then gsettings set org.gnome.TextEditor line-height 1.2; fi"
            - "if systemctl --user is-active --quiet dbus.service; then gsettings set org.gnome.TextEditor use-system-font false; fi"
            - "if systemctl --user is-active --quiet dbus.service; then gsettings set org.gnome.TextEditor style-scheme 'cypherriot'; fi"
        depends: [core.base]
        start: "Installing text editors"
        end: "Text editors configured"
        type: "Package"
        critical: false

    utilities:
        packages:
            - gnome-system-monitor
            #- iwgtk
            - file-roller
            # - secrets
            - fragments
            #- wget
        configs:
            - pattern: applications/*
        commands:
            - "mkdir -p ~/.local/share/applications"
            - "for d in /usr/share/applications /usr/local/share/applications ~/.local/share/applications; do for f in \"$d\"/electron*.desktop; do [ -e \"$f\" ] || continue; id=\"$(basename \"$f\")\"; tgt=\"$HOME/.local/share/applications/$id\"; cp \"$f\" \"$tgt\" 2>/dev/null || true; if grep -qE '^(Hidden|NoDisplay)=' \"$tgt\"; then sed -i 's/^Hidden=.*/Hidden=true/; s/^NoDisplay=.*/NoDisplay=true/' \"$tgt\"; else printf '\\nHidden=true\\nNoDisplay=true\\n' >> \"$tgt\"; fi; done; done"
            - "rm -f ~/.local/share/applications/Bluesky.desktop ~/.local/share/applications/bluesky.desktop; sudo rm -f /usr/local/share/applications/Bluesky.desktop /usr/local/share/applications/bluesky.desktop; sudo rm -f /usr/share/applications/Bluesky.desktop /usr/share/applications/bluesky.desktop || true"
            - "update-desktop-database ~/.local/share/applications/"
            - "sudo mkdir -p /etc/NetworkManager/conf.d"
            - "bash -lc 'printf \"[connection]\\nwifi.powersave=2\\n\" | sudo tee /etc/NetworkManager/conf.d/40-wifi-powersave.conf >/dev/null'"
            - "echo 'Wi-Fi power-save change will apply on next reboot (skipping NetworkManager reload to avoid VPN disruption)'"
        depends: [core.base]
        start: "Installing desktop utilities"
        end: "Desktop utilities installed"
        type: "Package"
        critical: false

development:
    tools:
        packages:
            - zed
            - tree
            - btop
            - vulkan-tools
        configs:
            - pattern: zed/*
              preserve_if_exists: [settings.json]
            - pattern: btop/*
        commands:
            - "ln -sf /usr/bin/zeditor ~/.local/bin/zed"
        depends: [core.base, system.hardware]
        start: "Installing development tools"
        end: "Development tools installed"
        type: "Package"
        critical: false

    helpers:
        packages:
            #- clang
            #- cmake
            #- ninja
            #- rust
            #- python-pip
            #- go
            #- github-cli
            - jq
            - zip
            - tmux
        commands:
            - "mkdir -p ~/.local/bin"
            - "curl -L -o ~/.local/bin/migrate https://raw.githubusercontent.com/CyphrRiot/Migrate/main/bin/migrate"
            - "curl -L -o ~/.local/bin/garp https://raw.githubusercontent.com/CyphrRiot/garp/main/bin/garp"
            - "chmod +x ~/.local/bin/migrate"
            - "chmod +x ~/.local/bin/garp"
        depends: [core.base]
        start: "Installing development helpers"
        end: "Development helpers installed"
        type: "Package"
        critical: false

    editors:
        packages:
            - tree-sitter-cli
            - lua-language-server
            - pyright
            - typescript-language-server
            - bash-language-server
            - gopls
        commands:
            - "sudo ln -sf /usr/bin/nvim /usr/bin/vi"
        depends: [core.base]
        start: "Installing editor and LSP servers"
        end: "Editor environment configured"
        type: "Package"
        critical: false

system:
    fonts:
        packages:
            # - ttf-hack-nerd
            # - ttf-cascadia-mono-nerd
            - ttf-nerd-fonts-symbols
            - noto-fonts
            - noto-fonts-emoji
            - noto-fonts-cjk
            - noto-fonts-extra
        commands:
            - "fc-cache -f"
            - "mkdir -p ~/.local/share/fonts/ && cp ~/.local/share/archriot/config/fonts/* ~/.local/share/fonts/"
        depends: [core.base]
        start: "Installing system fonts"
        end: "Fonts installed and cached"
        type: "System"
        critical: false

    bluetooth:
        packages:
            - blueberry
        commands:
            - "sudo systemctl enable --now bluetooth.service"
        depends: [core.base]
        start: "Setting up Bluetooth"
        end: "Bluetooth configured"
        type: "System"
        critical: false

    printer:
        packages:
            - cups
            - cups-pdf
            - cups-filters
            - system-config-printer
        commands:
            - "sudo systemctl enable --now cups.service"
        depends: [core.base]
        start: "Installing printing system"
        end: "Printing system configured"
        type: "System"
        critical: false

    power:
        packages:
            - power-profiles-daemon
            - powertop
        commands:
            - "sudo systemctl enable --now power-profiles-daemon.service"
            - 'for iface in /sys/class/net/*/device/power/wakeup; do [ -f "$iface" ] && [ -w "$iface" ] && echo enabled | sudo tee "$iface" >/dev/null 2>&1 || true; done'
            - 'find /sys/bus/usb/devices -name wakeup -type f 2>/dev/null | while read wakeup_file; do [ -w "$wakeup_file" ] && echo enabled | sudo tee "$wakeup_file" >/dev/null 2>&1 || true; done'
        depends: [core.base]
        start: "Configuring power management"
        end: "Power management configured"
        type: "System"
        critical: false

    filesystems:
        packages:
            - gvfs
            - udisks2
            - gvfs-smb
            - gvfs-mtp
            - ntfs-3g
            - dosfstools
            - exfatprogs
        commands:
            - "sudo systemctl enable --now udisks2.service"

        depends: [core.base]
        start: "Installing filesystem support"
        end: "Filesystem support configured"
        type: "System"
        critical: false

    networking:
        packages:
            - iwd
        commands:
            - "sudo systemctl enable --now iwd.service"
        depends: [core.base]
        start: "Configuring wireless networking"
        end: "Wireless networking configured"
        type: "System"
        critical: false

    audio:
        packages:
            - pipewire
            - pipewire-alsa
            - pipewire-pulse
            - pipewire-jack
            #- gst-plugin-pipewire
            #- wireplumber
            - pavucontrol
            - pamixer
            - playerctl
            - sof-firmware
            - alsa-firmware
            - linux-firmware
            - rtkit

        commands:
            - "if systemctl --user is-active --quiet dbus.service; then systemctl --user enable --now pipewire.service; else systemctl --user enable pipewire.service; fi"
            - "if systemctl --user is-active --quiet dbus.service; then systemctl --user enable --now pipewire-pulse.socket; else systemctl --user enable pipewire-pulse.socket; fi"
            - "if systemctl --user is-active --quiet dbus.service; then systemctl --user enable --now wireplumber.service; else systemctl --user enable wireplumber.service; fi"
            - "sleep 2"

        depends: [core.base]
        start: "Installing PipeWire audio system"
        end: "Audio system configured"
        type: "System"
        critical: true

    memory:
        commands:
            - |
                if [ -f "$HOME/.config/archriot/enable-memory-optimizations" ]; then
                  sudo cp ~/.local/share/archriot/config/system/99-memory-optimization.conf /etc/sysctl.d/99-memory-optimization.conf
                  total_kb=$(awk "/MemTotal/ {print \$2}" /proc/meminfo)
                  calc=$(awk -v t="$total_kb" 'BEGIN {m=int(t*0.01); if (m > 262144) m=262144; print m}')
                  sudo sed -i "s/^vm\.min_free_kbytes=.*/vm.min_free_kbytes=$calc/" /etc/sysctl.d/99-memory-optimization.conf
                  sudo sysctl -p /etc/sysctl.d/99-memory-optimization.conf
                else
                  echo "Skipping memory optimization (opt-in disabled). Create ~/.config/archriot/enable-memory-optimizations to enable."
                fi
        depends: [core.base]
        start: "Optimizing memory settings (opt-in)"
        end: "Memory optimization checked"
        type: "System"
        critical: false

    mimetypes:
        commands:
            - "mkdir -p ~/.local/share/applications"
            - "update-desktop-database ~/.local/share/applications"
            - |
                if systemctl --user is-active --quiet dbus.service; then
                  # Images
                  for mime in image/png image/jpeg image/gif image/webp image/bmp image/tiff; do
                    xdg-mime default org.gnome.Loupe.desktop "$mime"
                  done
                  # Documents
                  xdg-mime default org.gnome.Papers.desktop application/pdf
                  # Web browser
                  xdg-settings set default-web-browser archriot-brave.desktop
                  for scheme in x-scheme-handler/http x-scheme-handler/https; do
                    xdg-mime default archriot-brave.desktop "$scheme"
                  done
                  # Text files
                  for mime in text/plain text/markdown text/x-markdown application/x-markdown; do
                    xdg-mime default org.gnome.TextEditor.desktop "$mime"
                  done
                  # Video files
                  for mime in video/mp4 video/x-msvideo video/x-matroska video/x-flv video/x-ms-wmv video/mpeg video/ogg video/webm video/quicktime video/3gpp video/3gpp2 video/x-ms-asf video/x-ogm+ogg video/x-theora+ogg application/ogg; do
                    xdg-mime default mpv.desktop "$mime"
                  done
                fi
        depends: [desktop.apps, desktop.sources]
        start: "Configuring file associations"
        end: "File associations configured"
        type: "System"
        critical: false

    privacy:
        commands:
            - "if systemctl --user is-active --quiet dbus.service; then gsettings set org.gnome.desktop.privacy remember-recent-files false; fi"
            - "rm -f ~/.local/share/recently-used.xbel"
        depends: [core.base]
        start: "Configuring desktop privacy"
        end: "Privacy settings applied"
        type: "System"
        critical: false

    hardware:
        packages:
            - usbutils
            - pciutils
            - vulkan-icd-loader
            - mesa

        commands:
            - "sudo sed -i '/^#\\[multilib\\]/,/^#Include/ s/^#//' /etc/pacman.conf"
            - "sudo pacman -Sy"
            - "systemctl --user set-environment GSK_RENDERER=gl"
            - |
                if lspci | grep -qi "NVIDIA Corporation"; then
                  sudo pacman -S --needed --noconfirm nvidia nvidia-utils nvidia-settings || true
                fi
                if lspci | grep -qi "AMD/ATI"; then
                  sudo pacman -S --needed --noconfirm mesa vulkan-radeon libva-mesa-driver || true
                fi
                if lspci | grep -qi "Intel Corporation.*Graphics"; then
                  sudo pacman -S --needed --noconfirm mesa vulkan-intel intel-media-driver libva-intel-driver || true
                fi
        depends: [core.base]
        start: "Setting up basic hardware support"
        end: "Basic hardware support configured"
        type: "System"
        critical: true

    themes:
        packages:
            - bibata-cursor-theme
            - kora-icon-theme
            - gnome-themes-extra
            - kvantum-qt5
        configs:
            - pattern: default/icons/*
              target: ~/.icons/
            - pattern: gtk-3.0/*
            - pattern: gtk-4.0/*
        commands:
            - "mkdir -p ~/.config/gtk-3.0"
            - "[ ! -f ~/.config/gtk-3.0/bookmarks ] && echo -e \"file://$HOME/Documents\\nfile://$HOME/Downloads\\nfile://$HOME/Music\\nfile://$HOME/Pictures\\nfile://$HOME/Videos\" > ~/.config/gtk-3.0/bookmarks"
            - "gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita-dark'"
            - "sudo usermod -a -G video $USER"
        depends: [core.base]
        start: "Installing desktop themes"
        end: "Desktop themes configured"
        type: "Package"
        critical: false

    backgrounds:
        commands:
            - "mkdir -p ~/.config/archriot"
            - "if [ ! -f ~/.config/archriot/.current-background ]; then echo '~/.local/share/archriot/backgrounds/riot_01.jpg' > ~/.config/archriot/.current-background; fi"
        depends: [desktop.hyprland]
        start: "Configuring wallpaper settings"
        end: "Wallpaper configuration saved"
        type: "System"
        critical: false

media:
    players:
        packages:
            - showtime
            - mpv
            - lollypop
            - ffmpeg
            - libva-utils
        configs: []
        commands: []
        depends: [desktop.hyprland]
        start: "Installing media players"
        end: "Media players installed"
        type: "Package"
        critical: false
