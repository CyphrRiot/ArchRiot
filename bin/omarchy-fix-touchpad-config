#!/bin/bash

# ==============================================================================
# OhmArchy Touchpad Configuration Fix
# ==============================================================================
# Detects touchpad hardware and conditionally enables touchpad config in
# Hyprland configuration to prevent config errors on desktop systems
# ==============================================================================

HYPR_CONFIG="$HOME/.config/hypr/hyprland.conf"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ðŸ” Detecting touchpad hardware...${NC}"

# Check if touchpad exists using multiple methods
has_touchpad=false

# Method 1: Check hyprctl devices for touchpad
if hyprctl devices 2>/dev/null | grep -qi "touchpad"; then
    has_touchpad=true
    echo -e "${GREEN}âœ“ Touchpad detected via hyprctl${NC}"
fi

# Method 2: Check /proc/bus/input/devices for touchpad
if [[ "$has_touchpad" == false ]] && grep -qi "touchpad" /proc/bus/input/devices 2>/dev/null; then
    has_touchpad=true
    echo -e "${GREEN}âœ“ Touchpad detected via /proc/bus/input/devices${NC}"
fi

# Method 3: Check for common touchpad drivers in lsmod
if [[ "$has_touchpad" == false ]] && lsmod | grep -qE "(i2c_hid|hid_multitouch|psmouse|synaptics|elan)" 2>/dev/null; then
    has_touchpad=true
    echo -e "${GREEN}âœ“ Touchpad drivers detected${NC}"
fi

# Method 4: Check xinput (if available)
if [[ "$has_touchpad" == false ]] && command -v xinput &>/dev/null; then
    if xinput list 2>/dev/null | grep -qi "touchpad"; then
        has_touchpad=true
        echo -e "${GREEN}âœ“ Touchpad detected via xinput${NC}"
    fi
fi

if [[ "$has_touchpad" == false ]]; then
    echo -e "${YELLOW}âš  No touchpad detected - this appears to be a desktop system${NC}"
fi

# Check if Hyprland config exists
if [[ ! -f "$HYPR_CONFIG" ]]; then
    echo -e "${YELLOW}âš  Hyprland config not found at $HYPR_CONFIG${NC}"
    exit 1
fi

echo -e "${BLUE}ðŸ“ Updating Hyprland touchpad configuration...${NC}"

# Create backup
cp "$HYPR_CONFIG" "$HYPR_CONFIG.bak.$(date +%s)"

if [[ "$has_touchpad" == true ]]; then
    # Enable touchpad config
    echo -e "${GREEN}âœ“ Enabling touchpad configuration${NC}"
    sed -i 's/^[[:space:]]*# touchpad {/    touchpad {/' "$HYPR_CONFIG"
    sed -i 's/^[[:space:]]*#[[:space:]]*\(.*touchpad.*\)/        \1/' "$HYPR_CONFIG"
    sed -i 's/^[[:space:]]*# }/    }/' "$HYPR_CONFIG"
else
    # Disable touchpad config (comment it out)
    echo -e "${YELLOW}âœ“ Disabling touchpad configuration (no touchpad detected)${NC}"
    sed -i 's/^[[:space:]]*touchpad {/    # touchpad {/' "$HYPR_CONFIG"
    sed -i '/^[[:space:]]*touchpad {/,/^[[:space:]]*}/s/^[[:space:]]*\([^#]\)/    #     \1/' "$HYPR_CONFIG"
    sed -i 's/^[[:space:]]*}/    # }/' "$HYPR_CONFIG"
fi

# Reload Hyprland if it's running
if pgrep -x "Hyprland" >/dev/null; then
    echo -e "${BLUE}ðŸ”„ Reloading Hyprland configuration...${NC}"
    if hyprctl reload 2>/dev/null; then
        echo -e "${GREEN}âœ“ Hyprland configuration reloaded successfully${NC}"
    else
        echo -e "${YELLOW}âš  Failed to reload Hyprland - please restart Hyprland manually${NC}"
    fi
else
    echo -e "${YELLOW}â„¹ Hyprland not running - configuration will be applied on next start${NC}"
fi

echo -e "${GREEN}âœ… Touchpad configuration updated successfully${NC}"

if [[ "$has_touchpad" == true ]]; then
    echo -e "${BLUE}Touchpad features enabled:${NC}"
    echo -e "  â€¢ Tap-to-click"
    echo -e "  â€¢ Natural scroll disabled"
    echo -e "  â€¢ Disable while typing"
    echo -e "  â€¢ Traditional corner right-click"
else
    echo -e "${BLUE}Touchpad configuration disabled (desktop system)${NC}"
fi
