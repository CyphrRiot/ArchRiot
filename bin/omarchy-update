#!/bin/bash

echo "ðŸ”„ OhmArchy System Update"
echo "========================="

# Navigate to OhmArchy directory
cd ~/.local/share/omarchy || {
    echo "âŒ Error: OhmArchy directory not found"
    exit 1
}

# Determine migration starting point
if [[ $1 == "all" ]]; then
    last_updated_at=1
    echo "ðŸ“¦ Running all migrations"
else
    last_updated_at=$(git log -1 --format=%cd --date=unix 2>/dev/null || echo "1")
    echo "ðŸ“¦ Incremental update from $(date -d @$last_updated_at)"
fi

# Update OhmArchy repository
echo "â¬‡ï¸  Pulling latest OhmArchy changes..."
if git pull origin main; then
    echo "âœ“ Repository updated successfully"
else
    echo "âŒ Failed to update repository"
    exit 1
fi

# Run pending migrations
echo "ðŸ”§ Processing migrations..."
migration_count=0
for file in migrations/*.sh; do
    [[ -f "$file" ]] || continue

    migrate_at="${file##*/}"
    migrate_at="${migrate_at%.sh}"

    if [[ $migrate_at =~ ^[0-9]+$ ]] && [[ $migrate_at -gt $last_updated_at ]]; then
        echo "  ðŸš€ Running migration: $migrate_at"
        if source "$file"; then
            ((migration_count++))
        else
            echo "  âŒ Migration $migrate_at failed"
        fi
    fi
done

echo "âœ“ Processed $migration_count migrations"

# Update system packages
echo "ðŸ“¦ Updating system packages..."
yay -Syu --noconfirm && echo "âœ“ System packages updated" || echo "âš  Package update had issues"

echo "âœ… OhmArchy update complete!"
cd - >/dev/null
