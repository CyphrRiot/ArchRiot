# ArchRiot memory tuning
# ======================
# Goal: Prevent catastrophic RAM spikes from killing critical user processes
# (Waybar, compositor, shell) while keeping builds and large I/O smooth.
#
# Strategy
# - Prefer compressed swap (zram) under pressure (see: /etc/systemd/zram-generator.conf).
# - Keep dirty page writeback bounded to avoid huge bursts that stall the system.
# - Ensure OOM kills the allocating task (the real offender), not random services.
# - Keep kernel free-page margin reasonable to avoid reclaim thrash.
# - Raise max_map_count for apps/games that create many memory mappings.
#
# Notes
# - If you don't have zram, consider adding it (fast in-RAM swap) to improve behavior:
#     pacman -S zram-generator
#     sudo systemctl enable --now /dev/zram0.swap
#
# Safe defaults chosen to avoid harming builds while improving stability.

# 1) Swap behavior
# With zram present, a moderately higher swappiness is beneficial to shed inactive
# pages into compressed swap before the system gets tight on memory.
# If you strictly use disk swap (no zram), you may prefer 25â€“40 instead.
vm.swappiness = 60

# 2) Dirty page writeback (bytes-based limits override ratios)
# Keep background writeback small to start early, and cap max dirty memory to
# avoid multi-GB bursts that can cause stalls and OOM cascades.
# 64 MiB background, 256 MiB hard cap are balanced for NVMe/SATA and large builds.
vm.dirty_background_bytes = 67108864
vm.dirty_bytes = 268435456

# 3) OOM behavior
# Kill the task that actually triggered the out-of-memory condition instead of
# unrelated daemons (e.g., Waybar, compositor).
vm.oom_kill_allocating_task = 1

# 4) Overcommit policy
# Keep the kernel heuristic (0) to avoid surprising allocation failures in compilers.
# (2 = strict can break some builds; 1 = always overcommit can promote OOM storms)
vm.overcommit_memory = 0

# 5) Free memory watermark
# Reserve a modest free-page margin to keep kswapd ahead of pressure and reduce jitter.
# 64 MiB is conservative and scales fine for typical desktop RAM sizes.
vm.min_free_kbytes = 65536

# 6) VFS cache reclaim pressure
# Leave at the default behavior (100). Lower values retain inode/dentry caches longer
# which can reduce memory for apps under pressure; we prefer balanced reclaim.
vm.vfs_cache_pressure = 100

# 7) Mapping limits for heavy apps/games/tools (e.g., Steam/PoE, large language tools)
# Prevents failures due to high VMA counts; not a direct memory cap.
vm.max_map_count = 262144
